<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Streaming Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container py-4">
        <h1>Test Streaming Fix</h1>
        
        <div class="alert alert-info">
            <h5>Fixed Issues:</h5>
            <ul>
                <li>✅ <code>this.apiClient.post is not a function</code> → Fixed: Use <code>this.apiClient.request()</code></li>
                <li>✅ <code>streamingResults.viewDetails is not a function</code> → Fixed: Expose <code>window.streamingResults</code></li>
                <li>✅ Enhanced UI with diff highlighting</li>
            </ul>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test API Client</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testAPIClient()">Test API Client</button>
                        <div id="apiResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Streaming Results</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testStreamingResults()">Test Streaming Results</button>
                        <div id="streamingResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Console Logs</h5>
                </div>
                <div class="card-body">
                    <div id="consoleLogs" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Override console.log to show in our div
        const originalLog = console.log;
        const originalError = console.error;
        const logDiv = document.getElementById('consoleLogs');
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : 'text-light';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // Test API Client
        async function testAPIClient() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing...';
            
            try {
                // Simulate APIClient
                class TestAPIClient {
                    async request(endpoint, options = {}) {
                        console.log(`Making request to ${endpoint}`);
                        const response = await fetch(`http://localhost:8000${endpoint}`, options);
                        return await response.json();
                    }
                }
                
                const apiClient = new TestAPIClient();
                const result = await apiClient.request('/health');
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✅ API Client working!<br>
                        Response: ${JSON.stringify(result)}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ API Client error: ${error.message}
                    </div>
                `;
            }
        }

        // Test Streaming Results
        function testStreamingResults() {
            const resultDiv = document.getElementById('streamingResult');
            
            try {
                // Simulate StreamingResults
                class TestStreamingResults {
                    viewDetails(id) {
                        console.log(`Viewing details for: ${id}`);
                        return `Details for ${id}`;
                    }
                }
                
                // Test if method exists
                const streamingResults = new TestStreamingResults();
                const testResult = streamingResults.viewDetails('test-123');
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✅ Streaming Results working!<br>
                        Method result: ${testResult}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ Streaming Results error: ${error.message}
                    </div>
                `;
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            console.log('Page loaded, testing components...');
            setTimeout(() => {
                testAPIClient();
                testStreamingResults();
            }, 1000);
        });
    </script>
</body>
</html>

